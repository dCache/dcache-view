<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/dcache-namespace/dcache-namespace.html">

<link rel="import" href="../utils/ajax-ls/file-metadata.html">
<dom-module id="hover-contextual">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      paper-icon-button {
        color: #606060;
        width: 30px;
        height: 30px;
      }
      paper-icon-button + paper-icon-button {
        margin-left: -10px !important;
      }
    </style>
    <div>
      <paper-icon-button icon="delete" title="delete" id="delete"></paper-icon-button>
      <paper-icon-button icon="{{icon}}" title="{{tip}}" id="view"></paper-icon-button>
      <paper-icon-button icon="info" title="metadata information" id="info"></paper-icon-button>
    </div>
  </template>

  <script>
    HoverContextual = Polymer({
      is: 'hover-contextual',

      properties: {
        icon: {
          type: String,
          notify: true
        },

        tip: {
          type: String,
          notify: true
        },

        name: {
          type: String,
          notify: true
        },

        fileType: {
          type: String,
          notify: true
        },

        path: {
          type: String,
          notify: true
        },

        currentQos: {
            type: String,
            notify: true
        },

        index: {
            type: Number,
            notify: true
        }
      },

      factoryImpl: function(name, fileType, path, qos, index)
      {
        this.name = name;
        this.fileType = fileType;
        this.path = path;
        this.currentQos = qos;
        this.index = index;

        switch (fileType) {
          case "DIR":
            this.icon = "visibility";
            this.tip = "open folder";
            this.updateStyles();
            break;
          case "REGULAR":
            this.icon = "cloud-download";
            this.tip = "download file";
            break;
        }
      },

      listeners:
      {
        'view.tap': '_view',
        'info.tap': '_info',
        'delete.tap': '_delete'
      },

      _view: function(e)
      {
        e.stopPropagation();
        var x = this.fileType;
        var path;
        /**
         * TODO: Factor-out this code.
         * This code is similar to the function for the
         * on-tap event in the Pagination Button element.
         */
        if ( x == "DIR" ) {
          path = this.path;

          app.$.homedir.innerHTML = "";
          app.$.selectedTitle.querySelector("#pagination").innerHTML = "";

          var elRoot = new PaginationButton("Root", "/");
          if ( path == "/") {
            elRoot.querySelector('a').classList.add("active");
            app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
          } else {
            elRoot.querySelector('a').classList.remove("active");
            app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
            var dirNames = path.split("/");
            var pt =  "";
            for (var i = 1; i < dirNames.length; i++) {
              pt += "/" + dirNames[i];
              var el = new PaginationButton(dirNames[i], pt);
              el.querySelector('a').classList.remove("active");
              if ( i == (dirNames.length-1) ) {
                el.querySelector('a').classList.add("active");
              }
              app.$.selectedTitle.querySelector("#pagination").appendChild(el);
            }
          }

          var el1 = new ViewFile(path);
          app.$.homedir.appendChild(el1);

          Polymer.dom.flush();
        } else {
          //Download a file
          path = this._fileUrl("webdav");
          window.open(path);
        }
        e.stopPropagation();
      },

      _info: function(e)
      {
        e.stopPropagation();
        //TODO: Factor this function below out. Simply create an element for this sole purpose.
        var el1 = new FileMetadata(this.name, this.path, this.fileType, this.currentQos, this.index);
        app.$.metadataDrawer.innerHTML = "";
        app.$.metadataDrawer.appendChild(el1);
        Polymer.dom.flush();
        app.$.metadata.openDrawer();
        e.stopPropagation();
      },
      _delete: function ()
      {
        var url = this._fileUrl("rest");
        var name = this.name;
        var path = this.path;

        if (sessionStorage.upauth == null || sessionStorage.upauth === undefined){
            app.$.toast.text = 'You need to login to delete a file.';
            app.$.toast.show();
            return;
        }
        var namespace = document.createElement('dcache-namespace');
        namespace.auth = sessionStorage.upauth;
        namespace.promise.then(
          function () {
            var list = document.querySelector('iron-list');
            var arr = list.items;
            const len = arr.length;
            var i;
            for (i=0; i<len; i++) {
                if (arr[i].fileName == name) {
                    list.splice('items', i, 1);
                    break;
                }
            }

            if (len == 1) {
                var ed = document.createElement('empty-directory');
                var vf = document.querySelector('view-file');
                vf.querySelector('#content').appendChild(ed);
            }

            let type = this.fileType == "DIR" ? "Folder" : "File";
            app.$.toast.text = type + " deleted. ";
            app.$.toast.show();
          }
        ).catch(
          function(err) {
            app.$.toast.text = err.message;
            app.$.toast.show();
          }
        );
        namespace.rm({
            url: url,
            path: path
        });
      },

      _fileUrl: function (serviceEndpoint)
      {
          switch (serviceEndpoint) {
              case "webdav":
                  var webdav = window.CONFIG["dcache-view.endpoints.webdav"];
                  if (webdav == "") {
                      return window.location.protocol + "//" + window.location.hostname + ":2880" + this.path;
                  } else {
                      if (webdav.endsWith("/")) {
                          return webdav.substring(0, webdav.length-1) + this.path;
                      } else {
                          return webdav + this.path;
                      }
                  }
              case "rest":
                  return window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";
          }
      }
    });
  </script>
</dom-module>
