<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../../../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../list-view/list-row.html">
<link rel="import" href="../../directory-ls-message/empty-directory.html">
<link rel="import" href="../../directory-ls-message/directory-ls-error.html">
<link rel="import" href="../../user-authentication/user-login-page.html">
<link rel="import" href="../../user-authentication/switch-user-credential-dialog-box.html">

<dom-module id="view-file">
    <template>
        <style>
            :host {
                display: block;
                max-height: 100vh;
                display: flex;
                flex-direction: column;
                margin: 0px 30px;
                /*Prevent text selection after double click*/
                -webkit-user-select: none; /* webkit (safari, chrome) browsers */
                -moz-user-select: none; /* mozilla browsers */
                -khtml-user-select: none; /* webkit (konqueror) browsers */
                -ms-user-select: none; /* IE10+ */
            }
            .item {
                text-decoration: none !important;
                background-color: white;
                @apply(--layout-flex);
                cursor:pointer;
            }
            .item:hover {
                background-color: #e9e9e9;
            }
            .item.selected {
                background-color: #2196F3;
                color: #fafafa;
                outline: 0;
            }
            iron-list {
                flex: 1 1 auto;
            }
            .loading {
                text-align: center;
                height: 40px;
            }
            .loading paper-spinner {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
        </style>
        <iron-ajax id="ajax"
                   url="{{url}}"
                   method="GET"
                   content-type="application/json"
                   headers$='[[_computeHeaders(upw)]]'
                   handle-as="json" on-response="handleResponse"
                   on-error="handleError" loading="{{loading}}">
        </iron-ajax>
        <paper-material id="content" elevation="1">
            <iron-list id="feList" items="[]"
                       selected-item="{{selectedItem}}"
                       selected-items="{{selectedItems}}" selection-enabled>
                <template>
                    <div>
                        <list-row class$="[[_computedClass(selected)]]" tabindex$="[[tabIndex]]"
                                  name="{{item.fileName}}" file-type="{{item.fileType}}"
                                  ctime="{{item.creationTime}}" mtime="{{item.mtime}}"
                                  size="{{item.size}}" loc="{{item.fileLocality}}"
                                  parent-path="[[parent]]">
                        </list-row>
                    </div>
                </template>
            </iron-list>
        </paper-material>

        <div class="loading">
            <paper-spinner alt="Loading data" active="{{loading}}"></paper-spinner>
        </div>

        <iron-scroll-threshold id="threshold"
                               lower-threshold="500"
                               on-lower-threshold="_loadNamespaceData">
        </iron-scroll-threshold>
    </template>

    <script>
        ViewFile = Polymer
        ({
            is: "view-file",

            properties: {
                path: {
                    type: String,
                    value: "/",
                    notify: true
                },

                parent: {
                    type: String,
                    notify: true,
                    computed: '_computeParentPath(path)'
                },

                selectedItems: {
                    type: Object
                },

                selectedItem: {
                    type: Object
                },

                isSel: {
                    type: Boolean,
                    notify: true
                },

                upw: {
                    type: String,
                    notify: true,
                    computed: '_computedUpw(path)'
                },

                url: {
                    type: Object,
                    notify: true,
                    computed: '_url(path)'
                },

                name: {
                    type:String,
                    notify: true
                },

                target: {
                    type: Object,
                    value: function() {
                        return this.$.input;
                    }
                },

                __counter__: {
                    type: Number,
                    value: 0,
                    notify: true
                },
                loading: {
                    type: Boolean,
                    value: true,
                    notify: true
                }
            },

            observers: [
                'changedItems(items.*)'
            ],

            factoryImpl: function(path)
            {
                this.path = path;
            },

            ready: function ()
            {
                var target = app.$.homedir.parentNode;
                this.$.feList.scrollTarget = target;
                this.$.threshold.scrollTarget = target;
            },

            _computedUpw: function(path)
            {
                if (!(sessionStorage.upauth === undefined || sessionStorage.upauth == null)) {
                    return window.atob(sessionStorage.upauth);
                } else {
                    return "anonymous:nopassword";
                }
            },

            _computedClass: function(isSelected)
            {
                var classes = 'item';
                if (isSelected) {
                    classes += ' selected';
                }

                this.updateStyles();

                return classes;
            },

            _url: function(path)
            {
                if ( this.path==null || this.path == "" || this.path == "/") {
                    return window.CONFIG["dcache-view.endpoints.webapi"] + "namespace/?children=true&locality=true";
                } else {
                    path = decodeURIComponent(this.path);
                    path = path.replace(/=/g, "/");
                    return window.CONFIG["dcache-view.endpoints.webapi"] + "namespace"+ path +"/?children=true&locality=true";
                }
            },

            _computeParentPath: function(path)
            {
                if ( this.path == null || this.path == "" || this.path == "/" ) {
                    path = "/";
                    return path;
                } else {
                    path = decodeURIComponent(this.path);
                    path = path.replace(/=/g, "/");
                    return path + "/";
                }
            },

            _computeHeaders: function(upw)
            {
                return '{"Authorization":"Basic ' + window.btoa(upw)
                    + '", "Accept":"application/json", "Suppress-WWW-Authenticate": "Suppress"}';
            },

            handleResponse: function(e)
            {
                var children = e.detail.response.children;
                var d = this;

                if ( children.length == 0 && this.__counter__ == 0 ) {
                    var content = this.$.content;
                    var el1 = new EmptyDirectory();
                    content.appendChild(el1);
                } else {
                    children.forEach(function (child) {
                        d.$.feList.push('items', child)
                    });
                    this.$.threshold.clearTriggers();
                    this.__counter__++;
                }

                Polymer.dom.flush();
                this.updateStyles();

                e.stopPropagation();
            },

            handleError: function (e, request)
            {
                var x;
                var msg;
                var code;
                var content = this.$.content;

                try {
                    x = request.request.__data__.xhr.response.errors[0];
                    msg = x.message;
                    code = x.status;
                    switch (code) {
                        case 401:
                            var moreMessage = "If you have an account, enter your User Name and Password.";
                            var ulp = new UserLoginPage(moreMessage);
                            content.appendChild(ulp);
                            Polymer.dom.flush();
                            this.updateStyles();
                            return;
                            break;
                        case 403:
                            app.$.centralDialogBox.innerHTML = "";
                            var el2 = new SwitchUserCredentialDialogBox();
                            app.$.centralDialogBox.appendChild(el2);
                            Polymer.dom.flush();
                            this.updateStyles();
                            app.$.centralDialogBox.toggle();
                            break;
                    }
                } catch (err) {
                    msg = "Something is terribly wrong! Please contact your admin";
                    code = 500;
                }

                var el1 = new DirectoryLsError(msg, code);
                content.appendChild(el1);

                Polymer.dom.flush();
                this.updateStyles();

                e.stopPropagation();
            },

            changedItems: function (changedRecord)
            {
                if (changedRecord.path) {
                    this.querySelector('iron-list').fire('iron-resize');
                }
            },

            _loadNamespaceData: function ()
            {
                const limit = 100;
                var offset = this.__counter__ * limit;
                this.$.ajax.params = {"limit":limit, "offset": offset};
                this.$.ajax.generateRequest();
            }
        });
    </script>
</dom-module>