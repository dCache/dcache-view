<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../../../bower_components/dcache-namespace/dcache-namespace.html">

<link rel="import" href="../../list-view/list-row.html">
<link rel="import" href="../../directory-ls-message/empty-directory.html">
<link rel="import" href="../../directory-ls-message/directory-ls-error.html">
<link rel="import" href="../../user-authentication/user-login-page.html">
<link rel="import" href="../../user-authentication/switch-user-credential-dialog-box.html">

<dom-module id="view-file">
    <template>
        <style>
            :host {
                display: block;
                max-height: 100vh;
                display: flex;
                flex-direction: column;
                margin: 0px 30px;
                /*Prevent text selection after double click*/
                -webkit-user-select: none; /* webkit (safari, chrome) browsers */
                -moz-user-select: none; /* mozilla browsers */
                -khtml-user-select: none; /* webkit (konqueror) browsers */
                -ms-user-select: none; /* IE10+ */
            }
            .item {
                text-decoration: none !important;
                background-color: white;
                @apply(--layout-flex);
                cursor:pointer;
            }
            .item:focus {
                outline: 0 solid transparent !important;
            }
            .item:hover {
                background-color: #eee;
            }
            .item.selected {
                background-color: #f5f5f5;
            }
            iron-list {
                flex: 1 1 auto;
            }
            .loading {
                text-align: center;
                height: 40px;
            }
            .loading paper-spinner {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
        </style>
        <iron-ajax id="ajax"
                   url="{{url}}"
                   method="GET"
                   content-type="application/json"
                   headers$='[[_computeHeaders(upw)]]'
                   handle-as="json" on-response="handleResponse"
                   on-error="handleError" loading="{{loading}}">
        </iron-ajax>
        <paper-material id="content" elevation="1">
            <iron-list id="feList" items="[]"
                       selected-item="{{selectedItem}}"
                       selected-items="{{selectedItems}}"
                       selection-enabled multi-selection="{{multiSelection}}">
                <template>
                    <div>
                        <list-row class$="[[_computedClass(selected)]]" tabindex$="[[tabIndex]]"
                                  name="{{item.fileName}}" file-type="{{item.fileType}}"
                                  ctime="{{item.creationTime}}" mtime="{{item.mtime}}"
                                  size="{{item.size}}" current-qos="{{item.currentQos}}"
                                  file-mime-type="{{item.fileMimeType}}" file-m-data="{{item}}"
                                  parent-path="[[parent]]" checkbox-display="{{multiSelection}}">
                        </list-row>
                    </div>
                </template>
            </iron-list>
        </paper-material>
        <paper-dialog id="dialog"
                      horizontal-align="left" vertical-align="top"
                      style="margin:0; width:400px; background-color:#eee;">
            <div style="padding-top:0;padding-bottom:0;margin-top:0;margin-left:0;margin-right:0;">
                <iron-a11y-keys target="[[target]]"
                                keys="enter" on-keys-pressed="_rename">
                </iron-a11y-keys>
                <paper-input id="input" value="{{name::input}}"
                             auto-validate pattern="[^/]*" preventInvalidInput
                             error-message="Invalid name" required autofocus>
                </paper-input>
            </div>
        </paper-dialog>
        <div class="loading">
            <paper-spinner alt="Loading data" active="{{loading}}"></paper-spinner>
        </div>

        <iron-scroll-threshold id="threshold"
                               lower-threshold="500"
                               on-lower-threshold="_loadNamespaceData">
        </iron-scroll-threshold>
    </template>

    <script>
        ViewFile = Polymer
        ({
            is: "view-file",

            properties: {
                path: {
                    type: String,
                    value: "/",
                    notify: true
                },

                parent: {
                    type: String,
                    notify: true,
                    computed: '_computeParentPath(path)'
                },

                selectedItems: {
                    type: Object,
                    notify: true
                },

                selectedItem: {
                    type: Object
                },

                upw: {
                    type: String,
                    notify: true,
                    computed: '_computedUpw(path)'
                },

                url: {
                    type: Object,
                    notify: true,
                    computed: '_url(upw,path)'
                },

                name: {
                    type:String,
                    notify: true
                },

                target: {
                    type: Object,
                    value: function() {
                        return this.$.input;
                    }
                },

                __counter__: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                loading: {
                    type: Boolean,
                    value: true,
                    notify: true
                },

                multiSelection: {
                    type: Boolean,
                    value: function () {
                        if (app.$.selectedTitle.querySelector('paper-toggle-button') != null) {
                            return app.$.selectedTitle.querySelector('paper-toggle-button').active;
                        } else {
                            return false;
                        }
                    },
                    notify: true
                }
            },

            observers: [
                'changedItems(items.*)',
                'selectedItemsChanged(selectedItems.*)'
            ],

            factoryImpl: function(path)
            {
                this.path = path;
            },

            ready: function ()
            {
                var target = app.$.homedir.parentNode;
                this.$.feList.scrollTarget = target;
                this.$.threshold.scrollTarget = target;
            },

            _computedUpw: function(path)
            {
                if (!(sessionStorage.upauth === undefined || sessionStorage.upauth == null)) {
                    return window.atob(sessionStorage.upauth);
                } else {
                    return "anonymous:nopassword";
                }
            },

            _computedClass: function(isSelected)
            {
                let classes = 'item';
                if (isSelected) {
                    classes += ' selected';
                }

                if (this.multiSelection && isSelected){
                    this._checkCheckbox(event, true)
                } else if (this.multiSelection && !isSelected){
                    this._checkCheckbox(event, false)
                }

                this.updateStyles();

                return classes;
            },

            _checkCheckbox: function(e, state)
            {
                let i;
                const len = e.path.length;
                for (i=0; i<len; i++){
                    if (e.path[i].nodeName=="LIST-ROW"){
                        e.path[i].querySelector('paper-checkbox').checked = state;
                        break;
                    }
                }
            },

            _url: function(upw, path)
            {
                if ( path==null || path == "" || path == "/") {
                    return upw == "anonymous:nopassword" ?
                        window.CONFIG["dcache-view.endpoints.webapi"] + "namespace/?children=true" :
                        window.CONFIG["dcache-view.endpoints.webapi"] + "namespace/?children=true&qos=true";
                } else {
                    path = decodeURIComponent(path);
                    path = path.replace(/=/g, "/");
                    return upw == "anonymous:nopassword" ?
                        window.CONFIG["dcache-view.endpoints.webapi"] + path +"/?children=true" :
                        window.CONFIG["dcache-view.endpoints.webapi"] + "namespace"+ path +"/?children=true&qos=true";
                }
            },

            _computeParentPath: function(path)
            {
                if ( this.path == null || this.path == "" || this.path == "/" ) {
                    path = "/";
                    return path;
                } else {
                    path = decodeURIComponent(this.path);
                    path = path.replace(/=/g, "/");
                    return path + "/";
                }
            },

            _computeHeaders: function(upw)
            {
                return '{"Authorization":"Basic ' + window.btoa(upw)
                    + '", "Accept":"application/json", "Suppress-WWW-Authenticate": "Suppress"}';
            },

            handleResponse: function(e)
            {
                var children = e.detail.response.children;
                var d = this;

                if ( children.length == 0 && this.__counter__ == 0 ) {
                    var content = this.$.content;
                    var el1 = new EmptyDirectory();
                    content.appendChild(el1);
                } else {
                    children.forEach(function (child) {
                        d.$.feList.push('items', child)
                    });
                    this.$.threshold.clearTriggers();
                    this.__counter__++;
                }

                Polymer.dom.flush();
                this.updateStyles();

                e.stopPropagation();
            },

            handleError: function (e, request)
            {
                var x;
                var msg;
                var code;
                var content = this.$.content;

                try {
                    x = request.request.__data__.xhr.response.errors[0];
                    msg = x.message;
                    code = x.status;
                    switch (code) {
                        case 401:
                            var moreMessage = "If you have an account, enter your User Name and Password.";
                            var ulp = new UserLoginPage(moreMessage);
                            content.appendChild(ulp);
                            Polymer.dom.flush();
                            this.updateStyles();
                            return;
                            break;
                        case 403:
                            app.$.centralDialogBox.innerHTML = "";
                            var el2 = new SwitchUserCredentialDialogBox();
                            app.$.centralDialogBox.appendChild(el2);
                            Polymer.dom.flush();
                            this.updateStyles();
                            app.$.centralDialogBox.toggle();
                            break;
                    }
                } catch (err) {
                    msg = "Something is terribly wrong! Please contact your admin";
                    code = 500;
                }

                var el1 = new DirectoryLsError(msg, code);
                content.appendChild(el1);

                Polymer.dom.flush();
                this.updateStyles();

                e.stopPropagation();
            },

            changedItems: function (changedRecord)
            {
                if (changedRecord.path) {
                    this.querySelector('iron-list').fire('iron-resize');
                }
            },

            selectedItemsChanged: function (selectedItems)
            {
                if (document.getElementById('selectedTitle') != null) {
                    document.getElementById('selectedTitle').isSelected =
                        !(selectedItems.base == null || selectedItems.base.length == 0);
                }
                if (this.multiSelection) {
                    let items = this.$.feList.items;
                    let selectedLength = selectedItems.base == null ? 0 : selectedItems.base.length;
                    switch (selectedLength) {
                        case 0:
                            //nothing is selected
                            app.$.listTableHeader.querySelector('list-row-header').selection = 0;
                            break;
                        case items.length:
                            // all items in current view have been selected
                            app.$.listTableHeader.querySelector('list-row-header').selection = 2;
                            break;
                        default:
                            // some part of the items have been selected
                            app.$.listTableHeader.querySelector('list-row-header').selection = 1;
                    }
                }
            },

            openDialog: function (targetNode, name)
            {
                this.name = name;
                this._previousName = name;
                var dialog = Polymer.dom(this.root).querySelector('#dialog');
                dialog.positionTarget = targetNode.querySelector('#nameContainer');
                this._renameTargetNode = targetNode;
                dialog.open();
            },

            _rename: function ()
            {
                var d = this;
                var namespace = document.createElement('dcache-namespace');
                namespace.auth = window.btoa(this.upw);
                var path = this.path.endsWith("/") ? this.path : this.path + "/";
                var url = window.CONFIG["dcache-view.endpoints.webapi"] + "namespace";
                var source = path + this._previousName;
                var target = path + this.name;
                namespace.mv({
                    url: url,
                    path: source,
                    destination: target
                });

                var dialog = Polymer.dom(this.root).querySelector('#dialog');
                namespace.promise.then(
                    function () {
                        d._renameTargetNode.querySelector('#fileName').innerHTML = d.name;
                        d._renameTargetNode.name = d.name;
                        app.$.toast.text = "Done! File renamed. ";
                        app.$.toast.show();
                        dialog.close();
                    }
                ).catch(
                    function (err) {
                        app.$.toast.text = err.message;
                        app.$.toast.show();
                        dialog.close();
                    }
                );
            },

            _loadNamespaceData: function ()
            {
                const limit = 100;
                var offset = this.__counter__ * limit;
                this.$.ajax.params = {"limit":limit, "offset": offset};
                this.$.ajax.generateRequest();
            },

            /**
             * FIXME: This is a workaround to reset the checkbox.
             * This bug that should be fix.
             */
            resetMultiSelection: function ()
            {
                if (this.multiSelection) {
                    this.multiSelection = false;
                    this.multiSelection = true;
                }
            }
        });
    </script>
</dom-module>