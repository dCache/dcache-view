<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/notification-icons.html">

<link rel="import" href="../../../bower_components/file-icon/file-icon.html">

<link rel="import" href="../hover-contextual/hover-contextual.html">
<link rel="import" href="../utils/ajax-ls/view-file.html">
<link rel="import" href="../pagination-button/pagination-button.html">

<dom-module id="list-row">
    <style>
        :host {
            @apply(--layout-block);
            font-size: 0.7em;
        }
        .row {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            height: 40px;
            border-bottom: 1px solid #e5e5e5;
            text-decoration: none !important;
        }
        .name{
            @apply(--layout-flex-3);
        }
        .ctime, .locality {
            @apply(--layout-flex);
        }
        .locality {
            text-align: center;
        }
        .size {
            @apply(--layout-flex);
            text-align: right;
        }
        .size > span {
            padding-right: 10px;
        }
        .fit {
            @apply(--layout-fit);
        }
        .online {
            font-size: 0.3em;
            color: #2196F3;
        }
        .nearline {
            border: 1px solid #969696;
            border-radius:3px;
            margin: 0px !important;
            font-size: 0.1em !important;
            color: #f44336;
            -ms-transform: rotate(180deg); /* IE 9 */
            -webkit-transform: rotate(180deg); /* Chrome, Safari, Opera */
            transform: rotate(180deg);
            animation: blink-animation 1s steps(5, start) 3;
            -webkit-animation: blink-animation 1s steps(5, start) 3;
            width: 24px;
            height: 18px;
        }
        @keyframes blink-animation {
            to {visibility: hidden;}
        }
        @-webkit-keyframes blink-animation {
            to {visibility: hidden;}
        }
    </style>
    <template>
        <div id="row" class="row">
            <file-icon mime-type="{{fileMimeType}}" style="padding-left: 15px; padding-right: 10px"></file-icon>
            <div class="cell name">
                <label id="filename" style="padding-left:5px;">{{name}}</label>
            </div>
            <div class="cell ctime">{{computedCTime}}</div>
            <div class="cell locality">
                <template is="dom-if" if="{{isNearline}}" restamp>
                    <iron-icon icon="communication:voicemail" class="nearline"></iron-icon>
                </template>
                <template is="dom-if" if="{{isOnline}}" restamp>
                    <iron-icon icon="av:album" class="online"></iron-icon>
                </template>
            </div>
            <div class="cell size" id="hovering">
                <span>{{computedSize}}</span>
            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'list-row',

            properties: {
                name: {
                    type: String,
                    notify: true
                },

                fileType: {
                    type: String,
                    notify: true
                },

                fileMimeType: {
                    type: String,
                    notify: true,
                    computed:'_computedFileMimeType(fileType)'
                },

                ctime: {
                    type: String,
                    notify: true
                },

                computedCTime: {
                    type: String,
                    computed:'_computedCTime(ctime)'
                },

                mtime: {
                    type: String,
                    notify: true
                },

                size: {
                    type: String,
                    notify: true
                },

                computedSize: {
                    type: String,
                    computed:'_computeSize(fileType, size)'
                },

                parentPath: {
                    type: String,
                    notify: true
                },

                filePath: {
                    type: String,
                    computed:'_computeFilePath(parentPath, name)'
                },

                loc: {
                    type: String,
                    notify: true
                },

                locality: {
                    type: String,
                    notify: true,
                    computed: '_computeLocality(loc)'
                },
                isNearline: {
                    type: Boolean,
                    notify: true
                },
                isOnline: {
                    type: Boolean,
                    notify: true
                }
            },

            listeners: {
                'row.dblclick': '_openFileLoc',
                'row.mouseover': '_mouseOver',
                'row.mouseleave': '_mouseLeave'
            },

            _computeFilePath: function(parentPath, name)
            {
                return parentPath + name;
            },

            _computeLocality: function(loc)
            {
                if(loc == "NEARLINE"){
                    this.isNearline = true;
                    this.isOnline = false;
                } else if ( loc == "ONLINE") {
                    this.isNearline = false;
                    this.isOnline = true;
                } else {
                    this.isNearline = false;
                    this.isOnline = false;
                }
            },

            _computedCTime: function(ctime)
            {
                var x = new Date(ctime);
                return x.toLocaleString();
            },

            _computeSize: function(fileType, size)
            {
                if ( fileType == "DIR" ) {
                    return  "--";
                } else {
                    if (size == 0) {
                        return "0 Byte";
                    }

                    var k = 1000;
                    var dm = 1 || 3;
                    var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    var i = Math.floor(Math.log(size) / Math.log(k));

                    return parseFloat((size / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                }
            },

            _openFileLoc: function()
            {
                var x = this.fileType;
                var path;
                /**
                 * TODO: Factor-out this code.
                 * This code is similar to the function for the
                 * on-tap event in the Pagination Button element.
                 */
                if ( x == "DIR" ) {
                    path = this.filePath;

                    app.$.homedir.innerHTML = "";
                    app.$.selectedTitle.querySelector("#pagination").innerHTML = "";

                    var elRoot = new PaginationButton("Root", "/");
                    if ( path == "/") {
                        elRoot.querySelector('a').classList.add("active");
                        app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
                    } else {
                        elRoot.querySelector('a').classList.remove("active");
                        app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
                        var dirNames = path.split("/");
                        var pt =  "";
                        for (var i = 1; i < dirNames.length; i++) {
                            pt += "/" + dirNames[i];
                            var el = new PaginationButton(dirNames[i], pt);
                            el.querySelector('a').classList.remove("active");
                            if ( i == (dirNames.length-1) ) {
                                el.querySelector('a').classList.add("active");
                            }
                            app.$.selectedTitle.querySelector("#pagination").appendChild(el);
                        }
                    }

                    var el1 = new ViewFile(path);
                    app.$.homedir.appendChild(el1);

                    Polymer.dom.flush();
                } else {
                    //Download a file
                    var webdav = window.CONFIG["dcache-view.endpoints.webdav"];
                    if (webdav == "") {
                        path = window.location.protocol + "//" + window.location.hostname + ":2880" + this.filePath;
                    } else {
                        if (webdav.endsWith("/")) {
                            path = webdav.substring(0, webdav.length-1) + this.filePath;
                        } else {
                            path = webdav + this.filePath;
                        }
                    }
                    window.open(path);
                }
            },

            _mouseOver: function(e)
            {
                e.stopPropagation();
                var b = Polymer.dom(this.$.row).lastElementChild;
                var a = '<span class="style-scope list-row">'+this.computedSize+'</span>';
                if ( ((b.innerHTML).toString()).trim() == a.trim() ) {
                    b.querySelector('span').innerHTML = "";
                    var el1 = new HoverContextual(this.name, this.fileType, this.filePath);
                    b.querySelector('span').appendChild(el1);
                }
                Polymer.dom.flush();
                e.stopPropagation();
            },

            _mouseLeave: function(e)
            {
                e.stopPropagation();
                var b = this.$.hovering.querySelector('span');
                b.removeChild(b.lastChild);
                b.textContent = this.computedSize;
                Polymer.dom.flush();
                e.stopPropagation();
            },

            _computedFileMimeType: function (fileType)
            {
                if (fileType === "DIR") {
                    return "application/vnd.dcache.folder";
                }
                return "application/octet-stream";
            }
        });
    </script>
</dom-module>