<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../../../bower_components/file-icon/file-icon.html">

<link rel="import" href="../hover-contextual/hover-contextual.html">
<link rel="import" href="../utils/ajax-ls/view-file.html">
<link rel="import" href="../pagination-button/pagination-button.html">

<dom-module id="list-row">
    <style>
        :host {
            @apply(--layout-block);
            font-size: 0.7em;
        }
        .row {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            height: 40px;
            border-bottom: 1px solid #e5e5e5;
            text-decoration: none !important;
        }
        .name{
            @apply(--layout-flex-3);
        }
        .ctime, .qos {
            @apply(--layout-flex);
        }
        .size {
            @apply(--layout-flex);
            text-align: right;
        }
        .size > span {
            padding-right: 10px;
        }
        .fit {
            @apply(--layout-fit);
        }
        @keyframes blink-animation {
            to {visibility: hidden;}
        }
        @-webkit-keyframes blink-animation {
            to {visibility: hidden;}
        }
        #fileName {
            min-width:10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nameContainer {
            display: flex;
            align-items: center;
            padding-right: 24px;
        }
        .flex {
            flex-grow:1;
        }
        paper-icon-button {
            width: 34px !important;
            height: 34px !important;
            color: rgba(0, 0, 0, 0.54);
            --paper-icon-button-hover: {
                color: #f09300 !important;
            };
        }
        .checkbox {
            padding-left: 24px;
            --paper-checkbox-unchecked-color: rgba(0, 0, 0, 0.54);
            --paper-checkbox-unchecked-ink-color: rgba(0, 0, 0, 0.54);
        }
        .none {
            display: none;
        }
    </style>
    <template>
        <div id="row" class="row">
            <paper-checkbox class$="[[_computedClass(checkboxDisplay)]]" id="checkbox"></paper-checkbox>
            <file-icon mime-type="{{fileMimeType}}" style="padding-left: 15px; padding-right: 10px"></file-icon>
            <div class="cell name">
                <div id="nameContainer">
                    <span id="fileName" style="padding-left:5px;">{{name}}</span>
                    <span class="flex"></span>
                    <paper-icon-button icon="icons:create"
                                       title="click to edit file name"
                                       on-tap="_editFileName"></paper-icon-button>
                </div>
            </div>
            <div class="cell ctime">{{computedCTime}}</div>
            <div class="cell qos"><i>{{qosValue}}</i></div>
            <div class="cell size" id="hovering">
                <span>{{computedSize}}</span>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'list-row',

            properties: {
                name: {
                    type: String,
                    notify: true
                },

                fileType: {
                    type: String,
                    notify: true
                },

                fileMimeType: {
                    type: String,
                    notify: true
                },

                ctime: {
                    type: String,
                    notify: true
                },

                computedCTime: {
                    type: String,
                    computed:'_computedCTime(ctime)'
                },

                mtime: {
                    type: String,
                    notify: true
                },

                size: {
                    type: String,
                    notify: true
                },

                computedSize: {
                    type: String,
                    computed:'_computeSize(fileType, size)'
                },

                parentPath: {
                    type: String,
                    notify: true
                },

                filePath: {
                    type: String,
                    computed:'_computeFilePath(parentPath, name)'
                },

                currentQos: {
                    type: String,
                    notify: true
                },

                qosValue: {
                    type: String,
                    notify: true,
                    computed: '_computeQoSValue(currentQos)'
                },

                checkboxDisplay: {
                    type: Boolean,
                    notify: true
                },
                fileMData: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'row.dblclick': '_openFileLoc',
                'row.mouseover': '_mouseOver',
                'row.mouseleave': '_mouseLeave'
            },

            _computeFilePath: function(parentPath, name)
            {
                return parentPath + name;
            },

            _computeQoSValue: function(qos)
            {
                switch (qos) {
                    case "disk":
                        return "Disk";
                    case "tape":
                        return "Tape";
                    case "disk+tape":
                        return "Disk & Tape";
                    case "unavailable":
                        return "unavailable";
                }
            },

            _computedCTime: function(ctime)
            {
                var x = new Date(ctime);
                return x.toLocaleString();
            },

            _computeSize: function(fileType, size)
            {
                if ( fileType == "DIR" ) {
                    return  "--";
                } else {
                    if (size == 0) {
                        return "0 Byte";
                    }

                    var k = 1000;
                    var dm = 1 || 3;
                    var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    var i = Math.floor(Math.log(size) / Math.log(k));

                    return parseFloat((size / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                }
            },

            _computedClass: function (isDisplay)
            {
                this.$.checkbox.checked = false;
                let classes = 'checkbox';
                if (!isDisplay) {
                    classes += ' none';
                }
                this.updateStyles();
                return classes;
            },

            _openFileLoc: function()
            {
                var x = this.fileType;
                var path;
                /**
                 * TODO: Factor-out this code.
                 * This code is similar to the function for the
                 * on-tap event in the Pagination Button element.
                 */
                if ( x == "DIR" ) {
                    path = this.filePath;

                    app.$.homedir.innerHTML = "";
                    app.$.selectedTitle.querySelector("#pagination").innerHTML = "";

                    var elRoot = new PaginationButton("Root", "/");
                    if ( path == "/") {
                        elRoot.querySelector('a').classList.add("active");
                        app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
                    } else {
                        elRoot.querySelector('a').classList.remove("active");
                        app.$.selectedTitle.querySelector("#pagination").appendChild(elRoot);
                        var dirNames = path.split("/");
                        var pt =  "";
                        for (var i = 1; i < dirNames.length; i++) {
                            pt += "/" + dirNames[i];
                            var el = new PaginationButton(dirNames[i], pt);
                            el.querySelector('a').classList.remove("active");
                            if ( i == (dirNames.length-1) ) {
                                el.querySelector('a').classList.add("active");
                            }
                            app.$.selectedTitle.querySelector("#pagination").appendChild(el);
                        }
                    }

                    var el1 = new ViewFile(path);
                    app.$.homedir.appendChild(el1);

                    Polymer.dom.flush();
                } else {
                    //Download a file
                    var webdav = window.CONFIG["dcache-view.endpoints.webdav"];
                    if (webdav == "") {
                        path = window.location.protocol + "//" + window.location.hostname + ":2880" + this.filePath;
                    } else {
                        if (webdav.endsWith("/")) {
                            path = webdav.substring(0, webdav.length-1) + this.filePath;
                        } else {
                            path = webdav + this.filePath;
                        }
                    }
                    window.open(path);
                }
            },

            _mouseOver: function(e)
            {
                e.stopPropagation();
                var b = Polymer.dom(this.$.row).lastElementChild;
                var a = '<span class="style-scope list-row">'+this.computedSize+'</span>';
                if ( ((b.innerHTML).toString()).trim() == a.trim() ) {
                    b.querySelector('span').innerHTML = "";
                    const index = app.$.homeDir.querySelector('#feList').items.indexOf(this.fileMData);
                    const el1 = new HoverContextual(this.name, this.fileType,
                        this.filePath, this.fileMData.currentQos, index);
                    b.querySelector('span').appendChild(el1);
                }
                Polymer.dom.flush();
                e.stopPropagation();
            },

            _mouseLeave: function(e)
            {
                e.stopPropagation();
                var b = this.$.hovering.querySelector('span');
                b.removeChild(b.lastChild);
                b.textContent = this.computedSize;
                Polymer.dom.flush();
                e.stopPropagation();
            },

            _editFileName: function (e)
            {
                e.stopPropagation();
                var vf = document.querySelector('view-file');
                var targetNode = this;
                vf.openDialog(targetNode, this.name);
                e.stopPropagation();
            }
        });
    </script>
</dom-module>