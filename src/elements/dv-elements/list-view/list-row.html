<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../../../bower_components/file-icon/file-icon.html">

<link rel="import" href="../contextual-content/namespace-contextual-content.html">
<link rel="import" href="../utils/ajax-ls/view-file.html">
<link rel="import" href="../drag-and-drop/dnd-upload.html">

<dom-module id="list-row">
    <style>
        :host {
            @apply(--layout-block);
            font-size: 0.7em;
        }
        .row {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            height: 40px;
            border-bottom: 1px solid #e5e5e5;
            text-decoration: none !important;
        }
        .name{
            @apply(--layout-flex-3);
        }
        .ctime, .qos {
            @apply(--layout-flex);
        }
        .size {
            @apply(--layout-flex);
            text-align: right;
        }
        .size > span {
            padding-right: 10px;
        }
        .fit {
            @apply(--layout-fit);
        }
        @keyframes blink-animation {
            to {visibility: hidden;}
        }
        @-webkit-keyframes blink-animation {
            to {visibility: hidden;}
        }
        #fileName {
            min-width:10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #nameContainer {
            display: flex;
            align-items: center;
            padding-right: 24px;
        }

        paper-icon-button {
            width: 34px !important;
            height: 34px !important;
            color: rgba(0, 0, 0, 0.54);
            --paper-icon-button-hover: {
                color: #f09300 !important;
            };
        }
        .checkbox {
            padding-left: 24px;
            --paper-checkbox-unchecked-color: rgba(0, 0, 0, 0.54);
            --paper-checkbox-unchecked-ink-color: rgba(0, 0, 0, 0.54);
        }
        .none {
            display: none;
        }
    </style>
    <template>
        <div id="row" class="row">
            <paper-checkbox id="checkbox"
                            class$="[[_computedClass(checkboxDisplay)]]"></paper-checkbox>
            <file-icon mime-type="{{fileMimeType}}" style="padding-left: 15px; padding-right: 10px"></file-icon>
            <div class="cell name">
                <div id="nameContainer">
                    <span id="fileName" style="padding-left:5px;">{{name}}</span>
                </div>
            </div>
            <div class="cell ctime">{{computedCTime}}</div>
            <div class="cell qos"><i>{{qosValue}}</i></div>
            <div class="cell size" id="hovering">
                <span>{{computedSize}}</span>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'list-row',

            properties: {
                name: {
                    type: String,
                    notify: true
                },

                fileType: {
                    type: String,
                    notify: true
                },

                fileMimeType: {
                    type: String,
                    notify: true
                },

                ctime: {
                    type: String,
                    notify: true
                },

                computedCTime: {
                    type: String,
                    computed:'_computedCTime(ctime)'
                },

                mtime: {
                    type: String,
                    notify: true
                },

                size: {
                    type: String,
                    notify: true
                },

                computedSize: {
                    type: String,
                    computed:'_computeSize(fileType, size)'
                },

                parentPath: {
                    type: String,
                    notify: true
                },

                filePath: {
                    type: String,
                    computed:'_computeFilePath(parentPath, name)'
                },

                currentQos: {
                    type: String,
                    notify: true
                },

                qosValue: {
                    type: String,
                    notify: true,
                    computed: '_computeQoSValue(currentQos)'
                },

                checkboxDisplay: {
                    type: Boolean,
                    notify: true
                },

                fileMData: {
                    type: Object,
                    notify: true
                },

                counter: {
                    type: Number,
                    value: 0,
                    notify: true
                }
            },

            attached: function ()
            {
                this.listen(this.$.row, 'dblclick', '_openFileLoc');
                this.listen(this.$.row, 'contextmenu', '_openContextMenu');

                this.listen(this, 'drop', '_drop');
                this.listen(this, 'dragenter', '_dragenter');
                this.listen(this, 'dragleave', '_dragleave');
                this.listen(this, 'dragstart', '_dragstart');
            },

            detached: function ()
            {
                this.unlisten(this.$.row, 'dblclick', '_openFileLoc');
                this.unlisten(this.$.row, 'contextmenu', '_openContextMenu');

                this.unlisten(this, 'drop', '_drop');
                this.unlisten(this, 'dragenter', '_dragenter');
                this.unlisten(this, 'dragleave', '_dragleave');
                this.unlisten(this, 'dragstart', '_dragstart');
            },

            _drop: function (e)
            {
                e.stopPropagation();
                e.preventDefault();

                if (this.fileType === 'DIR') {
                    this.counter = 0;
                    app.clearDelayedLs();
                    if (event.dataTransfer.types.includes('text/plain')) {
                        app.dragNdropMoveFiles(this.filePath, true);
                        this.classList.remove('selected');
                    } else {
                        app.$.dropZoneToast.close();
                        let upload = new DndUpload(this.filePath);
                        upload.isCurrentView = false;
                        upload.start(event);
                    }
                }
                e.stopPropagation();
            },

            _dragenter: function (e)
            {
                e.stopPropagation();
                e.preventDefault();
                if ( this.fileType === "DIR" ) {
                    this.counter++;
                    if (!event.dataTransfer.types.includes('text/plain')) {
                        app.$.dropZoneContent.querySelector('drag-enter-toast').directoryName =
                            this.name;
                        if (!app.$.dropZoneToast.opened) {
                            app.$.dropZoneToast.open();
                        }
                    }
                    this.classList.add('selected');
                    app.delayTact(this);
                }
                e.stopPropagation();
            },

            _dragleave: function (e)
            {
                e.stopPropagation();
                e.preventDefault();
                if ( this.fileType === "DIR" ) {
                    this.counter--;
                    if (this.counter === 0) {
                        this.classList.remove('selected');
                        app.clearDelayedLs();
                    }
                }
                e.stopPropagation();
            },

            _dragstart: function ()
            {
                app.mvObj = {};
                app.notifyPath('mvObj');

                let vf = app.$.homedir.querySelector('view-file');
                if (vf.selectedItems.constructor === Array) {
                    app.mvObj.files= vf.selectedItems;
                } else {
                    app.mvObj.files = [vf.selectedItems];
                }
                app.mvObj.source = this.parentPath;
                app.notifyPath('mvObj');

                event.dataTransfer.setData('text/plain', 'draggable');
            },

            _computeFilePath: function(parentPath, name)
            {
                return parentPath + name;
            },

            _computeQoSValue: function(qos)
            {
                switch (qos) {
                    case "disk":
                        return "Disk";
                    case "tape":
                        return "Tape";
                    case "disk+tape":
                        return "Disk & Tape";
                    case "unavailable":
                        return "unavailable";
                }
            },

            _computedCTime: function(ctime)
            {
                var x = new Date(ctime);
                return x.toLocaleString();
            },

            _computeSize: function(fileType, size)
            {
                if ( fileType == "DIR" ) {
                    return  "--";
                } else {
                    if (size == 0) {
                        return "0 Byte";
                    }

                    var k = 1000;
                    var dm = 1 || 3;
                    var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    var i = Math.floor(Math.log(size) / Math.log(k));

                    return parseFloat((size / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                }
            },

            _computedClass: function (isDisplay)
            {
                this.$.checkbox.checked = false;
                let classes = 'checkbox';
                if (!isDisplay) {
                    classes += ' none';
                }
                this.updateStyles();
                return classes;
            },

            _openFileLoc: function()
            {
                if ( this.fileType == "DIR" ) {
                    app.ls(this.filePath);
                    Polymer.dom.flush();
                } else {
                    //Download a file
                    let path;
                    const webdav = window.CONFIG.webdavEndpoint;
                    if (webdav == "") {
                        path = window.location.protocol + "//" + window.location.hostname + ":2880" + this.filePath;
                    } else {
                        if (webdav.endsWith("/")) {
                            path = webdav.substring(0, webdav.length-1) + this.filePath;
                        } else {
                            path = webdav + this.filePath;
                        }
                    }
                    window.open(path);
                }
            },

            _openContextMenu: function (e)
            {
                e.stopPropagation();
                if (app.$.centralContextMenu.opened) {
                    app.$.centralContextMenu.close();
                }
                app.$.centralContextMenu.innerHTML = "";
                let cc;

                if (this.classList.contains('selected') &&
                    document.querySelector('view-file').selectedItems.length>1) {
                    cc = new NamespaceContextualContent(
                        {
                            files: document.querySelector('view-file').selectedItems,
                            parentPath: this.parentPath
                        }, 1);
                } else {
                    cc = new NamespaceContextualContent(this, 0);
                }

                app.$.centralContextMenu.appendChild(cc);
                let x = 0, y = 0;

                if (e.pageX || e.pageY) {
                    x = e.pageX;
                    y = e.pageY;
                } else if (e.clientX || e.clientY) {
                    x = e.clientX + document.body.scrollLeft +
                        document.documentElement.scrollLeft;
                    y = e.clientY + document.body.scrollTop +
                        document.documentElement.scrollTop;
                }

                const vx = window.innerWidth;
                const vy = window.innerHeight;
                const w = 250;
                const h = 340;

                if (vx - x < w && vy - y >= h) {
                    app.x = x-w;
                    app.y = y;
                } else if (vx - x < w && vy - y < h) {
                    app.x = x-w;
                    app.y = y-h;
                } else if (vx - x >= w && vy - y < h) {
                    app.x = x;
                    app.y = y-h;
                } else {
                    app.x = x;
                    app.y = y;
                }
                app.notifyPath('x');
                app.notifyPath('y');
                app.$.centralContextMenu.resetFit();
                app.$.centralContextMenu.open();

                e.preventDefault();
                e.stopPropagation();
            }
        });
    </script>
</dom-module>